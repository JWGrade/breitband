function speedTest(){function t(){}var a={indicator:{},graph:{}},e=["upload","download"],n={upload:6,download:30},r={upload:0,download:0},d={upload:0,download:0},o={upload:0,download:0},s={upload:!1,download:!1},i={upload:"up",download:"down"},l={upload:{x:null,y:null},download:{x:null,y:null}},p={width:150,height:150,radius:70},c={height:150,width:480},u=110,g=400,h={},y=d3.svg.arc().innerRadius(p.radius-2).outerRadius(p.radius+2),x=!1,f,w,m=49,v,A={upload:{x:d3.scale.linear().range([0,g]).domain([0,n.upload]),y:d3.scale.linear().range([0,u]).domain([100,0]),area:d3.svg.area().x(function(t){return A.upload.x(t[1]/m*n.upload)}).y1(function(t){return A.upload.y(t[0]/o.upload*100)}).y0(u)},download:{x:d3.scale.linear().range([0,g]).domain([0,n.download]),y:d3.scale.linear().range([0,u]).domain([100,0]),area:d3.svg.area().x(function(t){return A.download.x(t[1]/m*n.download)}).y1(function(t){return A.download.y(t[0]/o.download*100)}).y0(u)}};return t.init=function(){e.forEach(function(t,e){a.indicator[t]=d3.select("#"+t+"_indicator").append("svg").attr("height",p.height).attr("width",p.width).attr("viewBox","0 0 "+p.width+" "+p.height).attr("preserveAspectRatio","xMinYMin meet").append("g").attr("transform","translate("+p.width/2+","+p.height/2+")"),a.indicator[t].append("g").append("circle").attr("class","bg").attr("r",p.radius),a.indicator[t].append("text").style("opacity",.5).attr("dy",15).attr("text-anchor","middle").attr("id","spdtst_"+t).attr("class","speed_live").text("0.00"),a.indicator[t].append("text").style("opacity",.5).text(t).attr("text-anchor","middle").attr("dy",35).attr("class","speed_type"),a.indicator[t].append("text").style("opacity",.5).text("Mbit/s").attr("text-anchor","middle").attr("dy",-25).attr("class","speed_speed"),a.indicator[t].append("path").attr("transform","rotate("+d[t]+")").attr("id",t+"_progress").datum({newEndAngle:Math.PI/4,newStartAngle:0,startAngle:0,endAngle:Math.PI/4,opacity:0,type:t}).attr("d",y).attr("class","progress").style("opacity",0),a.graph[t]=d3.select("#"+t+"_graph").append("svg").attr("height",c.height).attr("width",c.width).attr("viewBox","0 0 "+c.width+" "+c.height).attr("preserveAspectRatio","xMinYMin meet").append("g").attr("transform","translate("+(c.width-g)/2+","+(c.height-u)/2+")");var r=[25,50,75,100];a.graph[t].append("g").selectAll("line").data(r).enter().append("line").attr("class","bglines").attr("x1",0).attr("x2",g).attr("y1",A[t].y).attr("y2",A[t].y),l[t].x=d3.svg.axis().orient("bottom").scale(A[t].x).ticks(7).tickFormat(function(a){return a+(a===n[t]?" Mbit/s":"")}),a.graph[t].append("g").attr("class","axis x-axis").attr("transform","translate(0,"+u+")").call(l[t].x),l[t].y=d3.svg.axis().orient("left").scale(A[t].y).tickValues([0,25,50,75,100]),a.graph[t].append("g").attr("class","axis y-axis").attr("transform","translate(0,0)").call(l[t].y)}),t.animate(),d3.json("./data/data.json",function(r,d){r&&console.log(r),v=d,e.forEach(function(t,e){o[t]=d3.max(v[t],function(t){return t[0]}),a.graph[t].append("g").append("path").datum(v[t]).attr("class","trend").attr("d",A[t].area),v[t].forEach(function(a,e){a[0]<v[t][0][0]/2&&!s[t]&&(s[t]=e)});var r=v[t][s[t]][0],d=v[t][s[t]-1][0],i=(v[t][0][0]/2-r)/(d-r);s[t]=v[t][s[t]][1]+i*(v[t][s[t]-1][1]-v[t][s[t]][1]),a.graph[t].append("g").attr("transform","translate("+A[t].x(s[t]/m*n[t])+","+A[t].y(50)+")").append("circle").attr("r",3).attr("class","avg"),a.graph[t].append("g").append("path").attr("class","avg").attr("d","M"+A[t].x(s[t]/m*n[t])+","+u+"L"+A[t].x(s[t]/m*n[t])+","+A[t].y(50)+"L"+A[t].x(n[t]/2)+","+A[t].y(62.5)+"L"+(A[t].x(n[t])-("upload"===t?0:57))+","+A[t].y(62.5));var l=a.graph[t].append("g").append("line").attr("class","coverup").attr("y1",u/4).attr("y2",u/4).attr("x1",g/2-5);"upload"===t?l.attr("x2",g):l.attr("x2",g-57);var p=a.graph[t].append("g").attr("transform","translate("+A[t].x(n[t]/2)+","+("upload"===t?5:20)+")").append("text");"upload"===t&&p.append("tspan").attr("x",0).attr("dy","1.25em").text("Durchschnitt Berliner Speed-Test"),p.append("tspan").attr("x",0).attr("dy","1.25em").text(("upload"===t?"Nutzer*innen: ":"")+(s[t]/m*n[t]).toFixed(2)+" Mbit/s "+t.charAt(0).toUpperCase()+t.slice(1))}),d3.select("#spdtst-start").on("click",function(){x||(x=!0,d3.select("#spdtst-start").text("Test lÃ¤uft...").classed("active",!0),d3.selectAll(".speed_live,.speed_speed,.speed_type,path").style("opacity",1),d3.selectAll("circle.userspeed").remove(),d3.selectAll("#spdtst path.progress").datum(function(t){return t.opacity=1,t.newEndAngle=Math.PI/4,t.endAngle=Math.PI/4,t}),t.animate(),d3.selectAll("#spdtst .speed_live").text("0.00"),f=new NDTPlugin("./js"),f.check()?f.getServer(function(a){f.setServer(a),f.run(),w=setInterval(t.reportStatus,100)},function(t){console.log("error",t)}):console.log("sorry your browser does not support this"))})})},t.speed2pop=function(t,a){var e=!1;v[a].forEach(function(r,d){n[a]/m*d>t&&!e&&(e=d)});var r=v[a][e][1]/m*n[a],d=v[a][e-1][1]/m*n[a],o=(t-r)/(d-r);return e=(v[a][e][0]+o*(v[a][e-1][0]-v[a][e][0]))/v[a][0][0]*100},t.animate=function(){e.forEach(function(a,e){d3.select("#"+a+"_progress").transition().duration(2e3).attrTween("transform",t.rotTween()).style("opacity",function(t){return t.opacity}).attrTween("d",t.arcTween()).each("end",function(a){"upload"===a.type&&x&&t.animate()})})},t.rotTween=function(){return function(t){var a=d3.interpolate(0,360);return function(t){return"rotate("+a(t)+")"}}},t.reportStatus=function(){var n=f.getStatus();e.forEach(function(e){var d=parseFloat(n[i[e]]);("NaN"===d||isNaN(d))&&(d=0),r[e]=d;var o=10>d?d.toFixed(2):d>99?Math.round(d):d.toFixed(1);a.indicator[e].select(".speed_live").text(o),d>0&&(d3.select("#"+e+"_progress").datum(function(t){return t.newEndAngle+=Math.PI/100,t}),"download"===e&&d3.select("#upload_progress").datum(function(a){return a.newEndAngle=2*Math.PI,a.opacity>0&&t.setPoint("upload"),a.opacity=0,a}))}),n.error.match(/completed/)&&(clearInterval(w),d3.select("#download_progress").datum(function(t){return t.newEndAngle=2*Math.PI,t.opacity=0,t}),setTimeout(function(){x=!1,t.setPoint("download"),d3.select("#spdtst-start").html('<span class="image image-speed"></span>Erneut testen!').classed("active",!1)},2e3))},t.setPoint=function(e){if(r[e]<n[e])for(var d=t.speed2pop(r[e],e),o=0;2>o;o++){var s=a.graph[e].append("circle").attr("r",5).attr("cx",A[e].x(r[e])).attr("cy",A[e].y(d)).attr("class","userspeed"+(0===o?" ani":""));0===o&&s.transition().duration(500).style("opacity",0).attr("r",20)}},t.arcTween=function(){return function(t){var a=d3.interpolate(t.startAngle,t.newStartAngle),e=d3.interpolate(t.endAngle,t.newEndAngle);return function(n){return t.endAngle=e(n),t.startAngle=a(n),y(t)}}},t}